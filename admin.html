<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FABARO NEWS — Admin</title>
<link rel="icon" href="logo.png" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{ --brand:#ef4444 }
  .card{ box-shadow:0 12px 32px rgba(2,6,23,.08) }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace }
  .btn{ transition:filter .15s, transform .02s } .btn:active{ transform:translateY(1px) }
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
    <img src="logo.png" alt="logo" class="h-9 w-9 object-contain">
    <div class="text-xl font-extrabold">FABARO <span class="text-[var(--brand)]">NEWS</span> • Admin</div>
    <div class="ml-auto text-xs text-slate-500">Tambah berita buatan sendiri → commit via Vercel API</div>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4 grid lg:grid-cols-2 gap-6">
  <!-- FORM -->
  <section class="bg-white border rounded-xl p-4 card">
    <h2 class="font-bold text-lg mb-3">Buat Berita</h2>
    <div class="grid gap-3">
      <label class="text-sm">Judul
        <input id="title" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="Judul berita..." />
      </label>

      <div class="grid grid-cols-2 gap-3">
        <label class="text-sm">Kategori
          <select id="category" class="mt-1 w-full px-3 py-2 border rounded-lg">
            <option value="nasional">Nasional</option>
            <option value="politik">Politik</option>
            <option value="bisnis">Bisnis</option>
            <option value="sport">Sport</option>
            <option value="tekno">Tekno</option>
            <option value="hiburan">Hiburan</option>
            <option value="music">Musik</option>
            <option value="movie">Film</option>
            <option value="hobi">Hobi</option>
            <option value="dunia">Dunia</option>
          </select>
        </label>
        <label class="text-sm">Waktu terbit
          <input id="publishedAt" type="datetime-local" class="mt-1 w-full px-3 py-2 border rounded-lg" />
        </label>
      </div>

      <label class="text-sm">Ringkasan
        <textarea id="summary" rows="3" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="Ringkasan singkat..."></textarea>
      </label>

      <label class="text-sm">Link sumber (opsional)
        <input id="link" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="https://..." />
      </label>

      <details class="mt-1">
        <summary class="cursor-pointer text-sm font-semibold">Konten penuh (HTML opsional)</summary>
        <textarea id="contentHtml" rows="6" class="mt-2 w-full px-3 py-2 border rounded-lg mono" placeholder="<p>Tulis HTML di sini...</p>"></textarea>
      </details>

      <div class="grid md:grid-cols-2 gap-3">
        <label class="text-sm">Gambar (URL)
          <input id="imageUrl" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="https://..." />
        </label>
        <label class="text-sm">atau Upload gambar
          <input id="imageFile" type="file" accept="image/*" class="mt-1 w-full px-3 py-2 border rounded-lg bg-white" />
          <div class="text-[11px] text-slate-500 mt-1">Auto-resize: max <b>1280px</b> • JPEG q=0.85</div>
        </label>
      </div>

      <div class="flex items-center gap-2 pt-1">
        <button id="previewBtn" class="btn px-4 py-2 rounded-lg bg-slate-900 text-white">Preview</button>
        <button id="publishBtn" class="btn px-4 py-2 rounded-lg bg-[var(--brand)] text-white">Publish</button>
        <span id="status" class="ml-2 text-sm text-slate-500"></span>
      </div>
    </div>
  </section>

  <!-- PREVIEW -->
  <section class="space-y-6">
    <div class="bg-white border rounded-xl p-4 card">
      <h2 class="font-bold text-lg mb-3">Preview</h2>
      <div class="rounded-xl overflow-hidden border">
        <div class="h-44 bg-slate-200" id="pv-img" style="background-size:cover;background-position:center"></div>
        <div class="p-4 space-y-2">
          <div class="text-xs text-slate-500 flex items-center gap-2">
            <span id="pv-cat" class="px-2 py-0.5 rounded-full border bg-white"></span>
            <span>FABARO NEWS</span>
            <span>•</span><time id="pv-time"></time>
          </div>
          <h3 id="pv-title" class="text-lg font-semibold leading-snug"></h3>
          <p id="pv-sum" class="text-sm text-slate-600"></p>
        </div>
      </div>
    </div>

    <div class="bg-white border rounded-xl p-4 card">
      <h2 class="font-bold text-lg mb-3">Info</h2>
      <p class="text-sm text-slate-600">Server (Vercel) akan commit ke repo menggunakan token dari Environment Variables, jadi aman & tidak kena CORS.</p>
    </div>
  </section>
</main>

<script>
const $ = (id)=>document.getElementById(id);
function fmtTimeLocalVal(d=new Date()){
  const p=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
}
if(!$("publishedAt").value) $("publishedAt").value = fmtTimeLocalVal(new Date());

function toISOLocal(v){ try{return new Date(v).toISOString()}catch{return new Date().toISOString()} }
function arrayBufferToBase64(buf){
  const bytes = new Uint8Array(buf), step = 0x8000; let bin="";
  for(let i=0;i<bytes.length;i+=step){ bin += String.fromCharCode.apply(null, bytes.subarray(i,i+step)); }
  return btoa(bin);
}
async function resizeImageFile(file, maxWidth=1280, quality=0.85){
  const bmp = await createImageBitmap(file);
  const scale = Math.min(1, maxWidth / bmp.width);
  const w = Math.round(bmp.width*scale), h = Math.round(bmp.height*scale);
  const canvas = document.createElement("canvas"); canvas.width=w; canvas.height=h;
  const ctx = canvas.getContext("2d"); ctx.drawImage(bmp,0,0,w,h);
  const blob = await new Promise(r=>canvas.toBlob(r,"image/jpeg",quality));
  return blob || file;
}

function buildData(imageURL=""){
  return {
    title: $("title").value.trim(),
    category: $("category").value,
    publishedAt: toISOLocal($("publishedAt").value),
    summary: $("summary").value.trim(),
    link: $("link").value.trim(),
    contentHtml: $("contentHtml").value.trim() || null,
    image: imageURL || $("imageUrl").value.trim() || null,
    source: "FABARO NEWS",
  };
}
function renderPreview(d){
  $("pv-title").textContent = d.title || "(judul)";
  $("pv-cat").textContent = d.category || "-";
  $("pv-time").textContent = new Intl.DateTimeFormat("id-ID",{dateStyle:"medium",timeStyle:"short"}).format(new Date(d.publishedAt||Date.now()));
  $("pv-sum").textContent = d.summary || "";
  const ph = "data:image/svg+xml;utf8,"+encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 18'><rect width='32' height='18' fill='#f1f5f9'/><rect x='3' y='4' width='26' height='10' rx='2' fill='#e2e8f0'/></svg>");
  $("pv-img").style.backgroundImage = `url('${d.image || ph}')`;
}
$("previewBtn").onclick = ()=> renderPreview(buildData());

/** ====== Panggil API serverless (same-origin) ====== **/
async function apiGet(path){
  const r = await fetch(`/api/github/get?path=${encodeURIComponent(path)}`);
  if (r.status===404) return {exists:false,sha:null,items:[]};
  const j = await r.json(); if(!r.ok) throw new Error(j.error||r.statusText); return j;
}
async function apiCommit({path,message,contentB64,sha}){
  const r = await fetch(`/api/github/commit`,{
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ path, message, contentB64, sha: sha||null })
  });
  const j = await r.json(); if(!r.ok) throw new Error(j.error||r.statusText); return j;
}
async function apiDispatch(){
  await fetch(`/api/github/dispatch`,{method:"POST"}); // ignore failure
}

$("publishBtn").onclick = async ()=>{
  try{
    $("status").textContent = "Menyiapkan…";

    // Upload gambar bila ada file
    let imgURL = $("imageUrl").value.trim();
    const file = $("imageFile").files[0];
    if (!imgURL && file){
      $("status").textContent = "Resize & upload gambar…";
      const resized = await resizeImageFile(file,1280,0.85);
      const buf = await resized.arrayBuffer();
      const b64 = arrayBufferToBase64(buf);
      const fname = `img-${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
      const imgPath = `images/uploads/${fname}`;
      await apiCommit({
        path: imgPath,
        message: `chore: upload ${fname}`,
        contentB64: b64
      });
      const { rawUrl } = await (await fetch(`/api/github/get?path=${encodeURIComponent(imgPath)}`)).json();
      imgURL = rawUrl; // raw content URL dari API
    }

    const data = buildData(imgURL);
    if(!data.title) return alert("Judul wajib diisi.");
    renderPreview(data);

    $("status").textContent = "Ambil mynews.json…";
    const cur = await apiGet("data/mynews.json");
    const items = Array.isArray(cur.items) ? cur.items : [];
    items.unshift({
      title: data.title, link: data.link || "#", publishedAt: data.publishedAt,
      source: "FABARO NEWS", category: data.category, image: data.image || null,
      summary: data.summary || null, contentHtml: data.contentHtml || null
    });

    $("status").textContent = "Commit mynews.json…";
    const contentB64 = btoa(unescape(encodeURIComponent(JSON.stringify(items,null,2))));
    await apiCommit({
      path: "data/mynews.json",
      message: `feat(admin): add "${data.title}"`,
      contentB64,
      sha: cur.sha || null
    });

    $("status").textContent = "Trigger build…";
    await apiDispatch();

    $("status").textContent = "Selesai. Tunggu halaman publik memuat data terbaru.";
    alert("Berhasil dipublish ✅");
  }catch(e){
    console.error(e);
    $("status").textContent = "Gagal.";
    alert("Publish gagal: "+e.message);
  }
};
</script>
</body>
</html>
